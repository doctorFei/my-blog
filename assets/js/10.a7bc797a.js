(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{419:function(t,s,a){"use strict";a.r(s);var n=a(29),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"vue-的生命周期之间到底做了什么事清？（源码详解，带你从头梳理组件化流程）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vue-的生命周期之间到底做了什么事清？（源码详解，带你从头梳理组件化流程）"}},[t._v("#")]),t._v(" Vue 的生命周期之间到底做了什么事清？（源码详解，带你从头梳理组件化流程）")]),t._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("相信大家对 Vue 有哪些生命周期早就已经烂熟于心，但是对于这些生命周期的前后分别做了哪些事情，可能还有些不熟悉。")]),t._v(" "),a("p",[t._v("本篇文章就从一个完整的流程开始，详细讲解各个生命周期之间发生了什么事情。")]),t._v(" "),a("p",[t._v("注意本文不涉及 "),a("code",[t._v("keep-alive")]),t._v(" 的场景和错误处理的场景。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cn.vuejs.org/images/lifecycle.png",alt:"vue生命周期"}})]),t._v(" "),a("h2",{attrs:{id:"初始化流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化流程"}},[t._v("#")]),t._v(" 初始化流程")]),t._v(" "),a("h3",{attrs:{id:"new-vue"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#new-vue"}},[t._v("#")]),t._v(" new Vue")]),t._v(" "),a("p",[t._v("从 "),a("code",[t._v("new Vue(options)")]),t._v(" 开始作为入口，"),a("code",[t._v("Vue")]),t._v(" 只是一个简单的构造函数，内部是这样的：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("进入了 "),a("code",[t._v("_init")]),t._v(" 函数之后，先初始化了一些属性。")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("initLifecycle")]),t._v("：初始化一些属性如"),a("code",[t._v("$parent")]),t._v("，"),a("code",[t._v("$children")]),t._v("。根实例没有 "),a("code",[t._v("$parent")]),t._v("，"),a("code",[t._v("$children")]),t._v(" 开始是空数组，直到它的 "),a("code",[t._v("子组件")]),t._v(" 实例进入到 "),a("code",[t._v("initLifecycle")]),t._v(" 时，才会往父组件的 "),a("code",[t._v("$children")]),t._v(" 里把自身放进去。所以 "),a("code",[t._v("$children")]),t._v(" 里的一定是组件的实例。")]),t._v(" "),a("li",[a("code",[t._v("initEvents")]),t._v("：初始化事件相关的属性，如 "),a("code",[t._v("_events")]),t._v(" 等。")]),t._v(" "),a("li",[a("code",[t._v("initRender")]),t._v("：初始化渲染相关如 "),a("code",[t._v("$createElement")]),t._v("，并且定义了 "),a("code",[t._v("$attrs")]),t._v(" 和 "),a("code",[t._v("$listeners")]),t._v(" 为"),a("code",[t._v("浅层")]),t._v("响应式属性。具体可以查看"),a("code",[t._v("细节")]),t._v("章节。并且还定义了"),a("code",[t._v("$slots")]),t._v("、"),a("code",[t._v("$scopedSlots")]),t._v("，其中 "),a("code",[t._v("$slots")]),t._v(" 是立刻赋值的，但是 "),a("code",[t._v("$scopedSlots")]),t._v(" 初始化的时候是一个 "),a("code",[t._v("emptyObject")]),t._v("，直到组件的 "),a("code",[t._v("vm._render")]),t._v(" 过程中才会通过 "),a("code",[t._v("normalizeScopedSlots")]),t._v(" 去把真正的 "),a("code",[t._v("$scopedSlots")]),t._v(" 整合后挂到 "),a("code",[t._v("vm")]),t._v(" 上。")])]),t._v(" "),a("p",[t._v("然后开始第一个生命周期：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("callHook(vm, 'beforeCreate')\n")])])]),a("h3",{attrs:{id:"beforecreate-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beforecreate-被调用完成"}},[t._v("#")]),t._v(" beforeCreate 被调用完成")]),t._v(" "),a("p",[a("code",[t._v("beforeCreate")]),t._v(" 之后")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("初始化 "),a("code",[t._v("inject")])])]),t._v(" "),a("li",[a("p",[t._v("初始化")])])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("state\n")])])]),a("ul",[a("li",[t._v("初始化 "),a("code",[t._v("props")])]),t._v(" "),a("li",[t._v("初始化 "),a("code",[t._v("methods")])]),t._v(" "),a("li",[t._v("初始化 "),a("code",[t._v("data")])]),t._v(" "),a("li",[t._v("初始化 "),a("code",[t._v("computed")])]),t._v(" "),a("li",[t._v("初始化 "),a("code",[t._v("watch")])])]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("初始化 "),a("code",[t._v("provide")])])]),t._v(" "),a("p",[t._v("所以在 "),a("code",[t._v("data")]),t._v(" 中可以使用 "),a("code",[t._v("props")]),t._v(" 上的值，反过来则不行。")]),t._v(" "),a("p",[t._v("然后进入 "),a("code",[t._v("created")]),t._v(" 阶段：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("callHook(vm, 'created')\n")])])]),a("h3",{attrs:{id:"created-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#created-被调用完成"}},[t._v("#")]),t._v(" created 被调用完成")]),t._v(" "),a("p",[t._v("调用 "),a("code",[t._v("$mount")]),t._v(" 方法，开始挂载组件到 "),a("code",[t._v("dom")]),t._v(" 上。")]),t._v(" "),a("p",[t._v("如果使用了 "),a("code",[t._v("runtime-with-compile")]),t._v(" 版本，则会把你传入的 "),a("code",[t._v("template")]),t._v(" 选项，或者 "),a("code",[t._v("html")]),t._v(" 文本，通过一系列的编译生成 "),a("code",[t._v("render")]),t._v(" 函数。")]),t._v(" "),a("ul",[a("li",[t._v("编译这个 "),a("code",[t._v("template")]),t._v("，生成 "),a("code",[t._v("ast")]),t._v(" 抽象语法树。")]),t._v(" "),a("li",[t._v("优化这个 "),a("code",[t._v("ast")]),t._v("，标记静态节点。（渲染过程中不会变的那些节点，优化性能）。")]),t._v(" "),a("li",[t._v("根据 "),a("code",[t._v("ast")]),t._v("，生成 "),a("code",[t._v("render")]),t._v(" 函数。")])]),t._v(" "),a("p",[t._v("对应具体的代码就是：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ast "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("trim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("optimize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("optimize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("generate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ast"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("如果是脚手架搭建的项目的话，这一步 "),a("code",[t._v("vue-cli")]),t._v(" 已经帮你做好了，所以就直接进入 "),a("code",[t._v("mountComponent")]),t._v(" 函数。")]),t._v(" "),a("p",[t._v("那么，确保有了 "),a("code",[t._v("render")]),t._v(" 函数后，我们就可以往"),a("code",[t._v("渲染")]),t._v("的步骤继续进行了")]),t._v(" "),a("h3",{attrs:{id:"beforemount-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beforemount-被调用完成"}},[t._v("#")]),t._v(" beforeMount 被调用完成")]),t._v(" "),a("p",[t._v("把 "),a("code",[t._v("渲染组件的函数")]),t._v(" 定义好，具体代码是：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("updateComponent")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_update")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("拆解来看，"),a("code",[t._v("vm._render")]),t._v(" 其实就是调用我们上一步拿到的 "),a("code",[t._v("render")]),t._v(" 函数生成一个 "),a("code",[t._v("vnode")]),t._v("，而 "),a("code",[t._v("vm._update")]),t._v(" 方法则会对这个 "),a("code",[t._v("vnode")]),t._v(" 进行 "),a("code",[t._v("patch")]),t._v(" 操作，帮我们把 "),a("code",[t._v("vnode")]),t._v(" 通过 "),a("code",[t._v("createElm")]),t._v("函数创建新节点并且渲染到 "),a("code",[t._v("dom节点")]),t._v(" 中。")]),t._v(" "),a("p",[t._v("接下来就是执行这段代码了，是由 "),a("code",[t._v("响应式原理")]),t._v(" 的一个核心类 "),a("code",[t._v("Watcher")]),t._v(" 负责执行这个函数，为什么要它来代理执行呢？因为我们需要在这段过程中去 "),a("code",[t._v("观察")]),t._v(" 这个函数读取了哪些响应式数据，将来这些响应式数据更新的时候，我们需要重新执行 "),a("code",[t._v("updateComponent")]),t._v(" 函数。")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mountComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("vm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  el"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("Element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  hydrating"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$el "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" el"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" createEmptyVNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"production"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* istanbul ignore if */")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("template "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("charAt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n        vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n        el\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("warn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"You are using the runtime-only build of Vue where the template "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"compiler is not available. Either pre-compile the templates into "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"render functions, or use the compiler-included build."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          vm\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("warn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Failed to mount component: template or render function not defined."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          vm\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callHook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"beforeMount"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" updateComponent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* istanbul ignore if */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"production"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("performance "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" mark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("updateComponent")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_uid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startTag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("vue-perf-start:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" endTag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("vue-perf-end:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mark")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("startTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vnode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mark")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("endTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("measure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("vue ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(" render")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" endTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mark")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("startTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_update")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mark")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("endTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("measure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("vue ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(" patch")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" endTag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("updateComponent")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_update")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// we set this to vm._watcher inside the watcher's constructor")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// since the watcher's initial patch may call $forceUpdate (e.g. inside child")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// component's mounted hook), which relies on vm._watcher being already defined")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Watcher")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    updateComponent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    noop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isMounted "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isDestroyed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callHook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"beforeUpdate"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* isRenderWatcher */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  hydrating "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// manually mounted instance, call mounted on self")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mounted is called for render-created child components in its inserted hook")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$vnode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isMounted "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callHook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mounted"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("如果是更新后调用 "),a("code",[t._v("updateComponent")]),t._v(" 函数的话，"),a("code",[t._v("updateComponent")]),t._v(" 内部的 "),a("code",[t._v("patch")]),t._v(" 就不再是初始化时候的创建节点，而是对新旧 "),a("code",[t._v("vnode")]),t._v(" 进行 "),a("code",[t._v("diff")]),t._v("，最小化的更新到 "),a("code",[t._v("dom节点")]),t._v(" 上去。具体过程可以看我的上一篇文章：")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.im/post/5e8694b75188257372503722",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么 Vue 中不要用 index 作为 key？（diff 算法详解）"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("这一切交给 "),a("code",[t._v("Watcher")]),t._v(" 完成：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Watcher")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  updateComponent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  noop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isMounted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callHook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"beforeUpdate"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* isRenderWatcher */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("注意这里在"),a("code",[t._v("before")]),t._v(" 属性上定义了"),a("code",[t._v("beforeUpdate")]),t._v(" 函数，也就是说在 "),a("code",[t._v("Watcher")]),t._v(" 被响应式属性的更新触发之后，重新渲染新视图之前，会先调用 "),a("code",[t._v("beforeUpdate")]),t._v(" 生命周期。")]),t._v(" "),a("p",[t._v("关于 "),a("code",[t._v("Watcher")]),t._v(" 和响应式的概念，如果你还不清楚的话，可以阅读我之前的文章：")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.im/post/5db6433b51882564912fc30f",target:"_blank",rel:"noopener noreferrer"}},[t._v("手把手带你实现一个最精简的响应式系统来学习 Vue 的 data、computed、watch 源码"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("注意，在 "),a("code",[t._v("render")]),t._v(" 的过程中，如果遇到了 "),a("code",[t._v("子组件")]),t._v("，则会调用 "),a("code",[t._v("createComponent")]),t._v(" 函数。")]),t._v(" "),a("p",[a("code",[t._v("createComponent")]),t._v(" 函数内部，会为子组件生成一个属于自己的"),a("code",[t._v("构造函数")]),t._v("，可以理解为子组件自己的 "),a("code",[t._v("Vue")]),t._v(" 函数：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Ctor = baseCtor.extend(Ctor)\n")])])]),a("p",[t._v("在普通的场景下，其实这就是 "),a("code",[t._v("Vue.extend")]),t._v(" 生成的构造函数，它继承自 "),a("code",[t._v("Vue")]),t._v(" 函数，拥有它的很多全局属性。")]),t._v(" "),a("p",[t._v("这里插播一个知识点，除了组件有自己的"),a("code",[t._v("生命周期")]),t._v("外，其实 "),a("code",[t._v("vnode")]),t._v(" 也是有自己的 "),a("code",[t._v("生命周期的")]),t._v("，只不过我们平常开发的时候是接触不到的。")]),t._v(" "),a("p",[t._v("那么"),a("code",[t._v("子组件的 vnode")]),t._v(" 会有自己的 "),a("code",[t._v("init")]),t._v(" 周期，这个周期内部会做这样的事情：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建子组件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" child "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createComponentInstanceForVnode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 挂载到 dom 上")]),t._v("\nchild"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("$mount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("而 "),a("code",[t._v("createComponentInstanceForVnode")]),t._v(" 内部又做了什么事呢？它会去调用 "),a("code",[t._v("子组件")]),t._v(" 的构造函数。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("new vnode.componentOptions.Ctor(options)\n")])])]),a("p",[t._v("构造函数的内部是这样的：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("Sub")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("VueComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("这个 "),a("code",[t._v("_init")]),t._v(" 其实就是我们文章开头的那个函数，也就是说，如果遇到 "),a("code",[t._v("子组件")]),t._v("，那么就会优先开始"),a("code",[t._v("子组件")]),t._v("的构建过程，也就是说，从 "),a("code",[t._v("beforeCreated")]),t._v(" 重新开始。这是一个递归的构建过程。")]),t._v(" "),a("p",[t._v("也就是说，如果我们有 "),a("code",[t._v("父 -> 子 -> 孙")]),t._v(" 这三个组件，那么它们的初始化生命周期顺序是这样的：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("父 beforeCreate\n父 create\n父 beforeMount\n子 beforeCreate\n子 create\n子 beforeMount\n孙 beforeCreate\n孙 create\n孙 beforeMount\n孙 mounted\n子 mounted\n父 mounted\n")])])]),a("p",[t._v("然后，"),a("code",[t._v("mounted")]),t._v(" 生命周期被触发。")]),t._v(" "),a("h3",{attrs:{id:"mounted-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mounted-被调用完成"}},[t._v("#")]),t._v(" mounted 被调用完成")]),t._v(" "),a("p",[t._v("到此为止，组件的挂载就完成了，初始化的生命周期结束。")]),t._v(" "),a("h2",{attrs:{id:"更新流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更新流程"}},[t._v("#")]),t._v(" 更新流程")]),t._v(" "),a("p",[t._v("当一个响应式属性被更新后，触发了 "),a("code",[t._v("Watcher")]),t._v(" 的回调函数，也就是 "),a("code",[t._v("vm._update(vm._render())")]),t._v("，在更新之前，会先调用刚才在 "),a("code",[t._v("before")]),t._v(" 属性上定义的函数，也就是")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("callHook(vm, 'beforeUpdate')\n")])])]),a("p",[t._v("注意，由于 Vue 的异步更新机制，"),a("code",[t._v("beforeUpdate")]),t._v(" 的调用已经是在 "),a("code",[t._v("nextTick")]),t._v(" 中了。 具体代码如下：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flushSchedulerQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" flushSchedulerQueue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" index"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    watcher "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("watcher"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("before"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// callHook(vm, 'beforeUpdate')")]),t._v("\n      watcher"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"beforeupdate-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beforeupdate-被调用完成"}},[t._v("#")]),t._v(" beforeUpdate 被调用完成")]),t._v(" "),a("p",[t._v("然后经历了一系列的 "),a("code",[t._v("patch")]),t._v("、"),a("code",[t._v("diff")]),t._v(" 流程后，组件重新渲染完毕，调用 "),a("code",[t._v("updated")]),t._v(" 钩子。")]),t._v(" "),a("p",[t._v("注意，这里是对 "),a("code",[t._v("watcher")]),t._v(" 倒序 "),a("code",[t._v("updated")]),t._v(" 调用的。")]),t._v(" "),a("p",[t._v("也就是说，假如同一个属性通过 "),a("code",[t._v("props")]),t._v(" 分别流向 "),a("code",[t._v("父 -> 子 -> 孙")]),t._v(" 这个路径，那么收集到依赖的先后也是这个顺序，但是触发 "),a("code",[t._v("updated")]),t._v(" 钩子确是 "),a("code",[t._v("孙 -> 子 -> 父")]),t._v(" 这个顺序去触发的。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("function callUpdatedHooks (queue) {\n  let i = queue.length\n  while (i--) {\n    const watcher = queue[i]\n    const vm = watcher.vm\n    if (vm._watcher === watcher && vm._isMounted) {\n      callHook(vm, 'updated')\n    }\n  }\n}\n")])])]),a("h3",{attrs:{id:"updated-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#updated-被调用完成"}},[t._v("#")]),t._v(" updated 被调用完成")]),t._v(" "),a("p",[t._v("至此，渲染更新流程完毕。")]),t._v(" "),a("h2",{attrs:{id:"销毁流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#销毁流程"}},[t._v("#")]),t._v(" 销毁流程")]),t._v(" "),a("p",[t._v("在刚刚所说的更新后的 "),a("code",[t._v("patch")]),t._v(" 过程中，如果发现有组件在下一轮渲染中消失了，比如 "),a("code",[t._v("v-for")]),t._v(" 对应的数组中少了一个数据。那么就会调用 "),a("code",[t._v("removeVnodes")]),t._v(" 进入组件的销毁流程。")]),t._v(" "),a("p",[a("code",[t._v("removeVnodes")]),t._v(" 会调用 "),a("code",[t._v("vnode")]),t._v(" 的 "),a("code",[t._v("destroy")]),t._v(" 生命周期，而 "),a("code",[t._v("destroy")]),t._v(" 内部则会调用我们相对比较熟悉的 "),a("code",[t._v("vm.$destroy()")]),t._v("。（keep-alive 包裹的子组件除外）")]),t._v(" "),a("p",[t._v("这时，就会调用 "),a("code",[t._v("callHook(vm, 'beforeDestroy')")])]),t._v(" "),a("h3",{attrs:{id:"beforedestroy-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beforedestroy-被调用完成"}},[t._v("#")]),t._v(" beforeDestroy 被调用完成")]),t._v(" "),a("p",[t._v("之后就会经历一系列的"),a("code",[t._v("清理")]),t._v("逻辑，清除父子关系、"),a("code",[t._v("watcher")]),t._v(" 关闭等逻辑。但是注意，"),a("code",[t._v("$destroy")]),t._v(" 并不会把组件从视图上移除，如果想要手动销毁一个组件，则需要我们自己去完成这个逻辑。")]),t._v(" "),a("p",[t._v("然后，调用最后的 "),a("code",[t._v("callHook(vm, 'destroyed')")])]),t._v(" "),a("h3",{attrs:{id:"destroyed-被调用完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#destroyed-被调用完成"}},[t._v("#")]),t._v(" destroyed 被调用完成")]),t._v(" "),a("h2",{attrs:{id:"细节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#细节"}},[t._v("#")]),t._v(" 细节")]),t._v(" "),a("h3",{attrs:{id:"attrs-和-listener-的一些处理。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#attrs-和-listener-的一些处理。"}},[t._v("#")]),t._v(" $attrs 和 $listener 的一些处理。")]),t._v(" "),a("p",[t._v("这里额外提一下 "),a("code",[t._v("$attrs")]),t._v(" 之所以只有第一层被定义为响应式，是因为一般来说深层次的响应式定义已经在父组件中定义做好了，只要保证 "),a("code",[t._v("vm.$attrs = newAttrs")]),t._v(" 这样的操作能触发子组件的响应式更新即可。（在子组件的模板中使用了 "),a("code",[t._v("$attrs")]),t._v(" 的情况下）")]),t._v(" "),a("p",[t._v("在更新子组件 "),a("code",[t._v("updateChildComponent")]),t._v(" 操作中，会去取收集到的 "),a("code",[t._v("vnode")]),t._v(" 上的 "),a("code",[t._v("attrs")]),t._v(" 和 "),a("code",[t._v("listeners")]),t._v(" 去更新 "),a("code",[t._v("$attrs")]),t._v(" 属性，这样就算子组件的模板上用了 "),a("code",[t._v("$attrs")]),t._v(" 的属性也可触发响应式的更新。")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" emptyObject "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"../util/index"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nvm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$attrs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parentVnode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("attrs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" emptyObject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nvm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$listeners "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" listeners "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" emptyObject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("有一个比较细节的操作是这样的：")]),t._v(" "),a("p",[t._v("这里的 "),a("code",[t._v("emptyObject")]),t._v(" 永远是同样的引用，也就能保证在没有 "),a("code",[t._v("attrs")]),t._v(" 或 "),a("code",[t._v("listeners")]),t._v(" 传递的时候，能够永远用同一个引用而不去触发响应式更新。")]),t._v(" "),a("p",[t._v("因为 "),a("code",[t._v("defineReactive")]),t._v(" 的 "),a("code",[t._v("set")]),t._v(" 函数中会做这样的判断：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reactiveSetter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("newVal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" getter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("obj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里引用相等 直接返回了")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newVal "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newVal "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" newVal "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"子组件的初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#子组件的初始化"}},[t._v("#")]),t._v(" 子组件的初始化")]),t._v(" "),a("p",[t._v("上文中提到，子组件的初始化也一样会走 "),a("code",[t._v("_init")]),t._v(" 方法，但是和根 "),a("code",[t._v("Vue")]),t._v(" 实例不同的是，在 "),a("code",[t._v("_init")]),t._v(" 中会有一个分支逻辑。")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isComponent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果是组件的话 走这个逻辑")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initInternalComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mergeOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveConstructorOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("constructor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    options "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    vm\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("根级别 Vue 实例，也就是 "),a("code",[t._v("new Vue(options)")]),t._v(" 生成是实例，它的 "),a("code",[t._v("$options")]),t._v(" 对象大概是这种格式的，我们定义在 "),a("code",[t._v("new Vue(options)")]),t._v(" 中的 "),a("code",[t._v("options")]),t._v(" 对象直接合并到了 "),a("code",[t._v("$options")]),t._v(" 上。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('beforeCreate: [ƒ]\nbeforeMount: [ƒ]\ncomponents: {test: {…}}\ncreated: [ƒ]\ndata: ƒ mergedInstanceDataFn()\ndirectives: {}\nel: "#app"\nfilters: {}\nmethods: {change: ƒ}\nmixins: [{…}]\nmounted: [ƒ]\nname: "App"\nrender: ƒ anonymous( )\n')])])]),a("p",[t._v("而子组件实例上的 "),a("code",[t._v("$options")]),t._v(" 则是这样的：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('parent: Vue {_uid: 0, _isVue: true, $options: {…}, _renderProxy: Proxy, _self: Vue, …}\npropsData: {msg: "hello"}\nrender: ƒ anonymous( )\nstaticRenderFns: []\n_componentTag: "test"\n_parentListeners: undefined\n_parentVnode: VNode {tag: "vue-component-1-test", data: {…}, children: undefined, text: undefined, elm: li, …}\n_propKeys: ["msg"]\n_renderChildren: [VNode]\n__proto__: Object\n')])])]),a("p",[t._v("那有人会问了，为啥我在子组件里通过 "),a("code",[t._v("this.$options")]),t._v(" 也能访问到定义在 "),a("code",[t._v("options")]),t._v(" 里的属性啊？")]),t._v(" "),a("p",[t._v("我们展开 "),a("code",[t._v("__proto__")]),t._v(" 属性看一下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("beforeCreate: [ƒ]\nbeforeMount: [ƒ]\ncreated: [ƒ]\ndirectives: {}\nfilters: {}\nmixins: [{…}]\nmounted: [ƒ]\nprops: {msg: {…}}\n_Ctor: {0: ƒ}\n_base: ƒ Vue(options)\n")])])]),a("p",[t._v("原来是被挂在原型上了，具体是 "),a("code",[t._v("initInternalComponent")]),t._v(" 中的这段话做的：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("const opts = vm.$options = Object.create(vm.constructor.options)\n")])])]),a("h3",{attrs:{id:"vnode-和-vnode-的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vnode-和-vnode-的区别"}},[t._v("#")]),t._v(" $vnode 和 _vnode 的区别")]),t._v(" "),a("p",[t._v("实例上有两个属性总是让人摸不着头脑，就是 "),a("code",[t._v("$vnode")]),t._v(" 和 "),a("code",[t._v("_vnode")]),t._v("，")]),t._v(" "),a("p",[t._v("举个例子来说，我们写了个这样的组件 "),a("code",[t._v("App")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("class-app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("test")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[a("code",[t._v("test")]),t._v(" 组件")]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("class-test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  Hi, I'm test\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("接下来我们都以 "),a("code",[t._v("test")]),t._v(" 组件举例，请仔细看清楚它们的父子关系以及使用的标签和类名。")]),t._v(" "),a("h4",{attrs:{id:"vnode"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vnode"}},[t._v("#")]),t._v(" $vnode")]),t._v(" "),a("p",[t._v("在渲染 "),a("code",[t._v("App")]),t._v(" 组件的时候，遇到了 "),a("code",[t._v("test")]),t._v(" 标签，会把 "),a("code",[t._v("test")]),t._v(" 组件包裹成一个 "),a("code",[t._v("vnode")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("class-app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  // 渲染到这里\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("test")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("形如此：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vue-component-1-test"')]),t._v("\nelm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" li"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("class"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("test\ncomponentInstance"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VueComponent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("_uid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _isVue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" $options"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\ncomponentOptions"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("propsData"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" listeners"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" children"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Ctor"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ƒ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ncontext"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Vue "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("_uid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _isVue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" $options"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _renderProxy"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _self"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Vue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" …"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ndata"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("attrs"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" on"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hook"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pendingInsert"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nchild"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("这个 "),a("code",[t._v("tag")]),t._v(" 为 "),a("code",[t._v("vue-component-1-test")]),t._v(" 的 "),a("code",[t._v("vnode")]),t._v("，其实可以说是把整个组件给包装了起来，通过 "),a("code",[t._v("componentInstance")]),t._v(" 属性可以访问到实例 "),a("code",[t._v("this")]),t._v("，")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("test")]),t._v(" 组件（比如说 "),a("code",[t._v("test.vue")]),t._v(" 文件）的视角来看，它应该算是 "),a("strong",[t._v("外部")]),t._v(" 的 "),a("code",[t._v("vnode")]),t._v("。（父组件在模板中读取到 "),a("code",[t._v("test.vue")]),t._v(" 组件后才生成）")]),t._v(" "),a("p",[t._v("它的 "),a("code",[t._v("elm")]),t._v(" 属性指向组件内部的 "),a("code",[t._v("根元素")]),t._v("，也就是 "),a("code",[t._v("li.class-test")]),t._v("。")]),t._v(" "),a("p",[t._v("此时，它在 "),a("code",[t._v("test")]),t._v(" 组件的实例 "),a("code",[t._v("this")]),t._v(" 上就保存为 "),a("code",[t._v("this.$vnode")]),t._v("。")]),t._v(" "),a("h4",{attrs:{id:"vnode-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vnode-2"}},[t._v("#")]),t._v(" _vnode")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("test")]),t._v(" 组件实例上，通过 "),a("code",[t._v("this._vnode")]),t._v(" 访问到的 "),a("code",[t._v("vnode")]),t._v(" 形如这样：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"li"')]),t._v("\nelm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" li"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("class"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("test\nchildren"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("VNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" VNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\ncontext"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VueComponent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("_uid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _isVue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" $options"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _renderProxy"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _self"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VueComponent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" …"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ndata"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("staticClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"class-test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nparent"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VNode "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vue-component-1-test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("…"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" children"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" text"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" elm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" li"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" …"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("可以看到，它的 "),a("code",[t._v("tag")]),t._v(" 是 "),a("code",[t._v("li")]),t._v("，也就是 "),a("code",[t._v("test")]),t._v(" 组件的 "),a("code",[t._v("template")]),t._v(" 上声明的 "),a("code",[t._v("最外层的节点")]),t._v("，")]),t._v(" "),a("p",[t._v("它的 "),a("code",[t._v("elm")]),t._v(" 属性也指向组件内部的 "),a("code",[t._v("根元素")]),t._v("，也就是 "),a("code",[t._v("li.class-test")]),t._v("。")]),t._v(" "),a("p",[t._v("它其实就是 "),a("code",[t._v("test")]),t._v(" 组件的 "),a("code",[t._v("render")]),t._v(" 函数返回的 "),a("code",[t._v("vnode")]),t._v("，")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("_update")]),t._v(" 方法中也找到了来源：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("_update")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("vnode"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vm"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_vnode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("回忆一下组件是怎么初始化挂载和更新的，是不是 "),a("code",[t._v("vm._update(vm._render())")]),t._v("？")]),t._v(" "),a("p",[t._v("所谓的 "),a("code",[t._v("diff")]),t._v(" 算法，"),a("code",[t._v("diff")]),t._v(" 的其实就是 "),a("code",[t._v("this")]),t._v(" 上保存的"),a("code",[t._v("_vnode")]),t._v("，和新调用 "),a("code",[t._v("_render")]),t._v(" 去生成的 "),a("code",[t._v("vnode")]),t._v(" 进行 "),a("code",[t._v("patch")]),t._v("。")]),t._v(" "),a("p",[t._v("而根 "),a("code",[t._v("Vue")]),t._v(" 实例，也就是 "),a("code",[t._v("new Vue()")]),t._v(" 的那层实例， "),a("code",[t._v("this.$vnode")]),t._v(" 就是 "),a("code",[t._v("null")]),t._v("，因为并没有外层组件去渲染它。")]),t._v(" "),a("h4",{attrs:{id:"总结关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结关系"}},[t._v("#")]),t._v(" 总结关系")]),t._v(" "),a("p",[a("code",[t._v("$vnode")]),t._v(" 外层组件渲染到当前组件标签时，生成的 "),a("code",[t._v("vnode")]),t._v(" 实例。")]),t._v(" "),a("p",[a("code",[t._v("_vnode")]),t._v(" 是组件内部调用 "),a("code",[t._v("render")]),t._v(" 函数返回的 "),a("code",[t._v("vnode")]),t._v(" 实例。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("_vnode.parent === $vnode\n")])])]),a("p",[t._v("他们的 "),a("code",[t._v("elm")]),t._v("，也就是实际 "),a("code",[t._v("dom元素")]),t._v("，都指向组件内部的"),a("code",[t._v("根元素")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"this-children-和-vnode-children"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#this-children-和-vnode-children"}},[t._v("#")]),t._v(" this.$children 和 _vnode.children")]),t._v(" "),a("p",[a("code",[t._v("$children")]),t._v(" 只保存当前实例的"),a("strong",[t._v("直接子组件")]),t._v(" 实例，所以你访问不到 "),a("code",[t._v("button")]),t._v("，"),a("code",[t._v("li")]),t._v(" 这些 "),a("code",[t._v("原生html标签")]),t._v("。注意是实例而不是 "),a("code",[t._v("vnode")]),t._v("，也就是通过 "),a("code",[t._v("this")]),t._v(" 访问到的那玩意。")]),t._v(" "),a("p",[a("code",[t._v("_vnode.children")]),t._v("，则会把当前组件的 "),a("code",[t._v("vnode")]),t._v(" 树全部保存起来，不管是"),a("code",[t._v("组件vnode")]),t._v("还是原生 html 标签生成的"),a("code",[t._v("vnode")]),t._v("，并且 原生 html 生成的 "),a("code",[t._v("vnode")]),t._v(" 内部还可以通过"),a("code",[t._v("children")]),t._v("进一步访问子"),a("code",[t._v("vnode")]),t._v("。")])])}),[],!1,null,null,null);s.default=e.exports}}]);